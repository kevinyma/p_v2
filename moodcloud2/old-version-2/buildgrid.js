var data = [[{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:2,&quot;percentageLT&quot;:0},
{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:5,&quot;percentageLT&quot;:10},
{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:20},
{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:30},
{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:40},
// {&quot;suitesCount&quot;:5,&quot;patientCount&quot;:5,&quot;percentageLT&quot;:50},
// {&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:60},
// {&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:70},
// {&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:80},
// {&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:90},
//{&quot;suitesCount&quot;:5,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:100}
            ],
[{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:10,&quot;percentageLT&quot;:0},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:10},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:3,&quot;percentageLT&quot;:20},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:30},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:20,&quot;percentageLT&quot;:40},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:50},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:60},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:5,&quot;percentageLT&quot;:70},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:80},
{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:90},
//{&quot;suitesCount&quot;:4,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:100}
],
[{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:5,&quot;percentageLT&quot;:0},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:10},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:20},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:30},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:40},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:50},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:60},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:70},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:80},
{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:90},
//{&quot;suitesCount&quot;:3,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:100}
],
[{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:20,&quot;percentageLT&quot;:0},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:10},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:20},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:30},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:40},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:50},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:60},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:2,&quot;percentageLT&quot;:70},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:80},
{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:1,&quot;percentageLT&quot;:90},
//{&quot;suitesCount&quot;:2,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:100}
],
[{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:0},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:10},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:20},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:30},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:40},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:10,&quot;percentageLT&quot;:50},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:60},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:70},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:80},
{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:0,&quot;percentageLT&quot;:90},
//{&quot;suitesCount&quot;:1,&quot;patientCount&quot;:5,&quot;percentageLT&quot;:100}
]];


/**
 *   buildGrid    Setup a grid:
 *   Rows = # of nested arrays, Columns = # of items in each nested array 
 *   @param id           div id tag starting with #
 *   @param width        width of the grid in pixels
 *   @param height       height of the grid in pixels
 *   @param square       true/false if you want the height to
 *                           match the (calculated first) width
 */
function buildGrid(id, width, height, square, dims, pData) {
    //format the data
    var _data = buildData(width, height, square, dims, pData);
    //console.log(_data);
    //&quot;#E42217&quot;, --save red for just the zero-centile column
    //&quot;#FFFFFF&quot;,
    
    //var sortedData = sortArray3(_data);

    var maxNum = d3.max(sortArray(_data), function (d, i) {
                        return d[0].patients;
                    }),
        domainScale = [0, 1, Math.round(maxNum/5), Math.round(maxNum/4), Math.round(maxNum/3), Math.round(maxNum/2),  maxNum],
        colorRange = [&quot;#FFFFFF&quot;, &quot;#E1F2CF&quot;, &quot;#C2E49D&quot;, &quot;#94D057&quot;,&quot;#73b040&quot;, &quot;#446621&quot;];
    //  &quot;#659730&quot;,
    var color = d3.scale.quantile() //color definitions for the number &quot;gravity&quot;
    .domain(domainScale)
        .range(colorRange);

     var tip = d3.tip()
                .attr(&#x27;class&#x27;, &#x27;d3-tip&#x27;)
                .html(function (d) { return &quot;&lt;span style=&#x27;bg-color:#CCCCCC;font-size:12;font-color:#555;opacity:.8;&#x27;&gt;&quot; + d + &quot; patients&lt;/span&gt;&quot;; });
    

    var grid = d3.select(id).append(&quot;svg&quot;)
        .attr(&quot;width&quot;, width)
        .attr(&quot;height&quot;, height)
        .attr(&quot;class&quot;, &quot;grid&quot;)
        .call(tip);

    var row = grid.selectAll(&quot;.row&quot;)
        .data(_data)
        .enter().append(&quot;svg:g&quot;)

        .attr(&quot;class&quot;, &quot;row&quot;);

    var col = row.selectAll(&quot;.cell&quot;)
        .data(function (d) {
        return d ;
    })
        .enter().append(&quot;svg:rect&quot;)
        .attr(&quot;class&quot;, &quot;cell&quot;)
        .attr(&quot;x&quot;, function (d) {
        return d.x;
    })
        .attr(&quot;y&quot;, function (d) {
        return d.y;
    })
        .attr(&quot;width&quot;, function (d) {
        return d.width;
    })
        .attr(&quot;height&quot;, function (d) {
        return d.height;
    })
         .on(&#x27;mouseover&#x27;, function (d) {
        d3.select(this)
            .style(&#x27;stroke&#x27;, &#x27;rgb(255,0,0)&#x27;)
            .style(&#x27;stroke-width&#x27;, &#x27;2.5px&#x27;)
            .style(&#x27;border&#x27;, &#x27;1px solid #FFFFFF&#x27;)
            .style(&#x27;padding&#x27;, &#x27;2px&#x27;);
         tip.show(d.patients);
      })
         .on(&#x27;mouseout&#x27;, function (d) {
         d3.select(this)
             .style(&#x27;stroke&#x27;, &#x27;#555&#x27;)
             .style(&#x27;stroke-width&#x27;, &#x27;1px&#x27;)
             .style(&#x27;border&#x27;, &#x27;1px solid #DDDDDD&#x27;)
             .style(&#x27;padding&#x27;, &#x27;1px&#x27;);
         tip.hide(d.patients);
     })
    .on(&#x27;click&#x27;, function () {
        console.log(d3.select(this));
    })
        .style(&quot;fill&quot;, function (d) {
        return color(d.patients);
    })
        .style(&quot;stroke&quot;, &#x27;#555&#x27;);
    
    
    var text = row.selectAll(&quot;.label&quot;)
        .data(function (d) {
        return d;
    })
        .enter().append(&quot;svg:text&quot;)
        .transition()
        .duration(2500)
        .delay(500)
        .attr(&quot;x&quot;, function (d) {
        return d.x + d.width / 2;
    })
        .attr(&quot;y&quot;, function (d) {
        return d.y + d.height / 2;
    })
        .attr(&quot;text-anchor&quot;, &quot;middle&quot;)
        .attr(&quot;dy&quot;, &quot;.35em&quot;)
        .text(function (d) {
        return d.patients;
    });
    
    
    
    /////Legend definition


        var legendBoxDim = 18;
        var legendDim = [655, d3.max(_data, function (d, i) { return d[i].y; }) / 4];
        //console.log(&quot;Legend dimensions&quot;, legendDim);
        var legend = grid.append(&#x27;g&#x27;)
        .attr(&#x27;class&#x27;, &#x27;legend&#x27;)
        .attr(&#x27;transform&#x27;, &#x27;rotate(90, 740, 175)&#x27;); // 

        //translate(&#x27; + (width-10) + &#x27;, -3)
        legend.selectAll(&quot;rect&quot;)
          .data(color.range().map(function (shade) {
              var d = color.invertExtent(shade);
              return d;
    }))
          .enter().append(&quot;rect&quot;)
            .transition()
            .duration(2500)
            .delay(500)
            .attr(&quot;height&quot;, legendBoxDim)
            .attr(&quot;x&quot;, function (d) {
                legendDim[0] += legendBoxDim;
                return legendDim[0];
            })
            .attr(&quot;y&quot;, (height/2))
            .attr(&quot;width&quot;, legendBoxDim)
        .style(&quot;fill&quot;, function (d) { return d &lt; 0 ? &quot;#E42217&quot; : color(d[0]); });

        var xStart = 421,
            yStart = -257;

        legend.selectAll(&quot;text&quot;)
            .data(color.domain().map(function (v, i) {
                var d = {};
                d.value = color.domain()[i];
                d.x = xStart;
                d.y = yStart;
               // console.log(&quot;color invert&quot;, v);
                xStart += legendBoxDim / 2;
                yStart -= legendBoxDim / 2;
                return d;
    }))
            .enter()
            .append(&quot;text&quot;)
            .attr(&quot;class&quot;, &quot;caption&quot;)
        //.attr(&quot;y&quot;, y.range()[1]) translate(&#x27; + d.position + &#x27; ,-3) 
        .attr(&#x27;transform&#x27;, function (d) {
            return &#x27;rotate(-90, &#x27; + d.x + &#x27;, &#x27; + d.y + &#x27;)&#x27;;
    })
        .text(function (d) {
            return d.value &lt; 0 ? &quot;&lt;0&quot; : d.value;
    });


        // top label for the y axis
    grid.append(&quot;text&quot;)
    .attr(&quot;x&quot;, 0)
    .attr(&quot;y&quot;, 20)
    .style(&quot;text-anchor&quot;, &quot;left&quot;)
    .text(&quot;Arousal&quot;);

        //build side labels for the y axis
    var nextStartY = dims[0] + 5; //20 + 15 + Math.round(dims[0]/2)
    for (var obj in _data) {

        grid.append(&quot;text&quot;)
            .attr(&quot;x&quot;, 20)
            .attr(&quot;y&quot;, (nextStartY + ((nextStartY - 5) * obj)))
            .style(&quot;text-anchor&quot;, &quot;left&quot;)
            .text(_data[obj][0].suites);

    }

        // build label for the x axis
        // use the length of the first nested array to determine how many (aka range)
    var nextStartX = dims[0]-5,
        nextStartY = height - 2;
    for (var i = 0; i &lt; (_data[0].length + 1); i++) {
        grid.append(&quot;text&quot;)
            .attr(&quot;x&quot;, function(){
                var ret = nextStartX;
                nextStartX += 59; //(i === 0 ? (ret + 55) : (ret + 60));
                return ret;})
            .attr(&quot;y&quot;, nextStartY)
            .style(&quot;text-anchor&quot;, &quot;bottom&quot;)
        .text((i&gt;0?(i * 10)+ &quot;%&quot;:i)); //special req to account for &quot;less than 10%&quot;

    }

    grid.append(&quot;text&quot;)
    .attr(&quot;x&quot;, nextStartX -= 50)
    .attr(&quot;y&quot;, nextStartY -= 30)
    .style(&quot;text-anchor&quot;, &quot;left&quot;)
    .text(&quot;Valence&quot;);
   /* }*/
    
    grid.append(&quot;text&quot;)
    .attr(&quot;x&quot;, nextStartX)
    .attr(&quot;y&quot;, nextStartY += 15)
    .style(&quot;text-anchor&quot;, &quot;left&quot;)
    .text(&quot;Care Opportunities&quot;);
    //}
}
        //////////////////////////////////////////////////////////////////////// 

function buildData(gridWidth, gridHeight, square, dims, ds) {
    var _data = [];
    var gridItemWidth = dims[0];
    var gridItemHeight = (square) ? gridItemWidth : dims[1];
    var startX = gridItemWidth;// / 2;
    var startY = gridItemHeight / 2;
    var stepX = gridItemWidth;
    var stepY = gridItemHeight;
    var xpos = startX;
    var ypos = startY;
    var newValue = 0;
    var prctg = 0;
    var suitesCount = 0;
        
    
    //parent array
    for (var index_a = 0; index_a &lt; ds.length; index_a++) {
        _data.push([]);
        //nested array
        for (var index_b = 0; index_b &lt; ds[index_a].length; index_b++) {
            
            suitesCount = ds[index_a][index_b].suitesCount;
            newValue = ds[index_a][index_b].patientCount;
            prctg = ds[index_a][index_b].percentageLT;
            
            
            _data[index_a].push({
                suites: suitesCount,
                patients: newValue,
                width: gridItemWidth,
                height: gridItemHeight,
                x: xpos,
                y: ypos,
                percentage: prctg
            });
            xpos += stepX;
        }
        xpos = startX;
        ypos += stepY;
        
    }

    return _data;
}

            //Sorting via the array container
                 function sortArray(arry) {
                     var retArry = []
                     for (var obj in arry) {

                         retArry.push(arry[obj].sort(function (a, b) { return sortArray2(a, b); }));
                     }
                     return retArry.filter(function (d) {
                         return d[0];
                     });
                 }
                 //sort the nested array, decending on patients to find highest number
                 function sortArray2(a, b) {
                     return d3.descending(a.patients, b.patients);
                 }

buildGrid(&#x27;.grid&#x27;, 770, 340,  true, [59], data);